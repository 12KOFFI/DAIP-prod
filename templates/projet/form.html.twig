{% extends 'base.html.twig' %}

{% block page_content %}

<div class="row mt-5 justify-content-center">
    <div class="col-md-9 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">{{ title|default('Projet') }}</h6>

                {{ form_start(form, {'attr': {'class': 'forms-sample', 'enctype': 'multipart/form-data'}}) }}

                <div class="row">
                    <div class="col-md-6">
                        {{ form_row(form.nom) }}
                    </div>
                    <div class="col-md-6">
                        {{ form_row(form.status) }}
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        {{ form_row(form.description) }}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        {{ form_row(form.dateDebut) }}
                    </div>
                    <div class="col-md-6">
                        {{ form_row(form.dateFin) }}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        {{ form_row(form.logo) }}
                        {% if projet and projet.logo %}
                            <div class="mt-2">
                                <small>Logo actuel :</small><br>
                                <img src="{{ asset('uploads/projet/logo/' ~ projet.logo) }}" alt="Logo" class="img-thumbnail" style="max-width: 150px;">
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {{ form_row(form.image) }}
                        {% if projet and projet.image %}
                            <div class="mt-2">
                                <small>Image illustrative actuelle :</small><br>
                                <img src="{{ asset('uploads/projet/images/' ~ projet.image) }}" alt="Image illustrative" class="img-thumbnail" style="max-width: 150px;">
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                {{ form_label(form.id_partenaire) }}
                            </div>
                            <div class="ms-2 mb-2">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="add-partenaire-btn" data-url="{{ path('app_partenaire_new', {'_popup': 1}) }}">
                                    Ajouter un partenaire
                                </button>
                            </div>
                        </div>
                        <div id="projet-partenaires-field">
                            {{ form_errors(form.id_partenaire) }}
                            <div class="row g-2" id="projet-partenaires-list">
                                {% for partenaireField in form.id_partenaire %}
                                    <div class="col-12 col-md-6 col-lg-4">
                                        <div class="form-check">
                                            {{ form_widget(partenaireField, {'attr': {'class': 'form-check-input'}}) }}
                                            {{ form_label(partenaireField, null, {'label_attr': {'class': 'form-check-label'}}) }}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            {{ form_help(form.id_partenaire) }}
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <a href="{{ path('app_projet_index') }}" class="btn btn-secondary">Annuler</a>
                        <button type="submit" class="btn btn-primary ms-2">
                            {{ button_label|default('Enregistrer') }}
                        </button>
                    </div>
                </div>

                {{ form_widget(form._token) }}

                {{ form_end(form, {'render_rest': false}) }}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="partenaireModal" tabindex="-1" aria-labelledby="partenaireModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="partenaireModalLabel">Ajouter un partenaire</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="partenaireModalBody">
                <div class="text-center py-4">Chargement...</div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        (function() {
            const btn = document.getElementById('add-partenaire-btn');
            const modalEl = document.getElementById('partenaireModal');
            const modalBody = document.getElementById('partenaireModalBody');

            if (!btn || !modalEl || !modalBody || typeof bootstrap === 'undefined') {
                return;
            }

            const modal = new bootstrap.Modal(modalEl);

            function attachModalFormHandler() {
                const form = modalBody.querySelector('form');
                if (!form) return;

                form.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    try {
                        const response = await fetch(form.action, {
                            method: form.method || 'POST',
                            body: new FormData(form),
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });

                        const contentType = response.headers.get('content-type') || '';

                        if (contentType.includes('application/json')) {
                            const data = await response.json();
                            if (data && data.success && data.partenaire) {
                                addPartenaireToProjetField(data.partenaire);
                                modal.hide();
                                return;
                            }
                        }

                        const html = await response.text();
                        modalBody.innerHTML = html;
                        attachModalFormHandler();
                    } catch (err) {
                        console.error(err);
                        modalBody.innerHTML = '<div class="alert alert-danger">Une erreur est survenue.</div>';
                    }
                }, { once: true });
            }

            function addPartenaireToProjetField(partenaire) {
                const list = document.getElementById('projet-partenaires-list');
                if (!list) return;

                const existingInput = list.querySelector('input[type="checkbox"]');
                const name = existingInput ? existingInput.name : 'projet[id_partenaire][]';
                const inputId = (existingInput && existingInput.id ? existingInput.id.replace(/\d+$/, '') : 'projet_id_partenaire_') + 'new_' + partenaire.id;

                const col = document.createElement('div');
                col.className = 'col-12 col-md-6 col-lg-4';

                const formCheck = document.createElement('div');
                formCheck.className = 'form-check';

                const input = document.createElement('input');
                input.type = 'checkbox';
                input.name = name;
                input.value = partenaire.id;
                input.id = inputId;
                input.checked = true;
                input.className = 'form-check-input';

                const label = document.createElement('label');
                label.htmlFor = inputId;
                label.className = 'form-check-label';
                label.appendChild(document.createTextNode(partenaire.nom));

                formCheck.appendChild(input);
                formCheck.appendChild(label);
                col.appendChild(formCheck);
                list.appendChild(col);
            }

            btn.addEventListener('click', async function() {
                const url = btn.getAttribute('data-url');
                if (!url) return;

                modalBody.innerHTML = '<div class="text-center py-4">Chargement...</div>';
                modal.show();

                try {
                    const response = await fetch(url, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    const html = await response.text();
                    modalBody.innerHTML = html;
                    attachModalFormHandler();
                } catch (err) {
                    console.error(err);
                    modalBody.innerHTML = '<div class="alert alert-danger">Impossible de charger le formulaire.</div>';
                }
            });
        })();
    </script>
{% endblock %}