{% set base_template = is_granted('IS_AUTHENTICATED_FULLY') ? 'base.html.twig' : 'base.config.html.twig' %}
{% extends base_template %}

{% block title %}{{ (title|default('Nouvelle Candidature')) ~ ' | ' ~ parent() }}{% endblock %}

{% block meta %}
    {{ parent() }}
    <meta name='keywords' content='e2c, tic, recrutement, formation, vae'/>
    <meta name='description' content="Formulaire de candidature E2C_TIC"/>
    <meta property="og:type" content="article" />
    <meta property="og:url" content="{{ app.request.uri }}" />
    <meta property="og:title" content="Formulaire de candidature E2C_TIC" />
    <meta property="og:description" content="Formulaire de candidature E2C_TIC" />
    <meta property="og:image" content="{{ app.request.getSchemeAndHttpHost() ~ '/images/logo.png' }}" />
{% endblock %}



{% block stylesheets %}
    {{ parent() }}
    <style>
        /* Styles pour la progression visuelle */
        .progress-steps {
            position: relative;
        }

        .step-item {
            flex: 0 0 auto;
            z-index: 1;
        }

        .step-circle {
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .step-circle i {
            font-size: 20px;
        }

        .step-label {
            font-weight: 600;
            color: #6c757d;
        }

        .step-connector {
            transition: background 0.3s ease;
        }

        /* Animation pour les fichiers uploadés */
        .file-upload-wrapper {
            position: relative;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .file-upload-wrapper:hover {
            background-color: #f8f9fa;
        }

        .file-upload-wrapper i {
            font-size: 1.2rem;
            vertical-align: middle;
        }

        /* Amélioration des cards */
        .card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: box-shadow 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .card-title i {
            color: #6c757d;
        }

        /* Styles pour les alertes */
        .alert {
            border-left: 4px solid;
            border-radius: 8px;
        }

        .alert-info {
            border-left-color: #0dcaf0;
            background-color: #cff4fc;
        }

        .alert-warning {
            border-left-color: #ffc107;
            background-color: #fff3cd;
        }

        .alert-success {
            border-left-color: #198754;
            background-color: #d1e7dd;
        }

        /* Animation de chargement */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        select:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        /* Styles pour les icônes dans les inputs */
        .form-group-with-icon {
            position: relative;
        }

        /* Amélioration des selects */
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        }

        /* Responsive pour mobile */
        @media (max-width: 768px) {
            .progress-steps {
                flex-direction: column;
                align-items: center;
            }

            .step-connector {
                width: 2px !important;
                height: 30px !important;
                margin: 10px 0 !important;
            }

            .step-item {
                margin-bottom: 10px;
            }
        }

        /* Styles responsifs pour les boutons du formulaire */
        .form-buttons-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
            padding: 1rem 0;
        }
        
        .form-buttons-container .btn {
            min-width: 140px;
            transition: all 0.3s ease;
        }
        
        /* Mobile XS - jusqu'à 360px */
        @media (max-width: 360px) {
            .form-buttons-container {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.75rem 0;
            }
            
            .form-buttons-container .btn {
                width: 100%;
                min-width: auto;
                font-size: 0.85rem;
                padding: 0.5rem 1rem;
            }
        }
        
        /* Mobile Small - 361px à 480px */
        @media (max-width: 480px) {
            .form-buttons-container {
                flex-direction: column;
                gap: 0.6rem;
                padding: 0.875rem 0;
            }
            
            .form-buttons-container .btn {
                width: 100%;
                min-width: auto;
                font-size: 0.875rem;
                padding: 0.5625rem 1rem;
            }
        }
        
        /* Mobile Medium - 481px à 576px */
        @media (max-width: 576px) {
            .form-buttons-container {
                gap: 0.625rem;
                padding: 0.9375rem 0;
            }
            
            .form-buttons-container .btn {
                min-width: 130px;
                font-size: 0.9rem;
                padding: 0.5625rem 1rem;
            }
        }
        
        /* Mobile Large - 577px à 768px */
        @media (max-width: 768px) {
            .form-buttons-container {
                gap: 0.6875rem;
            }
            
            .form-buttons-container .btn {
                min-width: 135px;
                font-size: 0.925rem;
            }
        }
        
        /* Amélioration pour les très petits écrans */
        @media (max-width: 320px) {
            .form-buttons-container .btn {
                font-size: 0.8rem;
                padding: 0.4375rem 0.875rem;
            }
        }
        
        /* Animation et effets hover */
        .form-buttons-container .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        @media (max-width: 576px) {
            .form-buttons-container .btn:hover {
                transform: none;
                box-shadow: none;
            }
        }
        
        /* Amélioration de l'accessibilité */
        .form-buttons-container .btn:focus {
            outline: 2px solid var(--bs-primary);
            outline-offset: 2px;
        }
        
        /* Gestion des marges sur mobile */
        @media (max-width: 576px) {
            .text-center.my-4 {
                margin-top: 1.5rem !important;
                margin-bottom: 1.5rem !important;
            }
        }
    </style>
{% endblock %}

{% block body %}
    {% block page_content %}
        {% set hidePersonalInfo = hide_personal_info|default(false) %}
        <div class="container" style="margin-bottom: 5rem; margin-top: 2rem;">
            {% for type, messages in app.flashes %}
                {% for message in messages %}
                    <div class='alert alert-{{ type }} alert-dismissible fade show mb-3 text-center'><i class='fa fa-exclamation-circle'></i> {{ message }}</div>
                {% endfor %}
            {% endfor %}

            {# Pré-calcul des données pour optimisation #}
            {% if form.vars.value and form.vars.value.id %}
                {% set piecesJointes = form.vars.value.pieceJointe %}
                {% set photo = piecesJointes|filter(p => p.type == 'PHOTO')|first %}
                {% set pieceCNI = piecesJointes|filter(p => p.type == 'CNI')|first %}
                {% set extraitNaissance = piecesJointes|filter(p => p.type == 'EXTRACT_NAISSANCE')|first %}
                {% set diplome = piecesJointes|filter(p => p.type == 'DIPLOME')|first %}

                {% set hasPiece = pieceCNI is not null %}
                {% set hasExtrait = extraitNaissance is not null %}
                {% set hasDiplome = diplome is not null %}
                {% set dossierComplet = hasPiece and hasExtrait and hasDiplome %}

                <div class='card border mb-3'>
                    <div class='card-body'>
                        <div class='row'>
                            <div class='col-md-3 text-center'>
                                {% if form.vars.value.sexe == 'MASCULIN' %}
                                    <i class='fa fa-male' aria-hidden="true"></i>
                                {% else %}
                                    <i class='fa fa-female text-danger' aria-hidden="true"></i>
                                {% endif %}
                                <span class="visually-hidden">Sexe: {{ form.vars.value.sexe }}</span>

                                {{ form.vars.value.nom|upper }} {{ form.vars.value.prenom|upper }}
                                <div>{{ form.vars.value.dateNaissance ? form.vars.value.dateNaissance|date('d/m/Y') : '' }}</div>

                                {% set photoPath = photo and photo.chemin ? 'uploads/candidatures/' ~ form.vars.value.numCandidature ~ '/' ~ (photo.chemin|split('/')|last) : '' %}
                                <img class='border' style='width: 130px; height: 130px; object-fit: cover;'
                                     src='{{ photoPath ? asset(photoPath) : 'https://daip.ci/public/image/user.png' }}'
                                     alt="Photo de {{ form.vars.value.prenom }} {{ form.vars.value.nom }}"
                                     onerror="this.src='https://daip.ci/public/image/user.png'">
                                <div class='fw-bold'>{{ form.vars.value.numCandidature }}</div>
                            </div>
                            <div class='col-md-9'>
                                <div class='d-flex justify-content-between'>
                                    {% if form.vars.value.metier is not empty %}
                                        <div class='fw-bold'>
                                            {{ form.vars.value.metier.nom }}
                                        </div>
                                    {% endif %}
                                    {% if not dossierComplet %}
                                        <span class='badge border text-danger me-1' role="status">Dossier Incomplet</span>
                                    {% endif %}
                                </div>
                                <hr>
                                <div class="table-responsive">
                                    <table class='table'>
                                        <tbody>
                                        <tr>
                                            <td class='wrap text-wrap'>CNI ou l'Attestation d'Identité</td>
                                            <td class='text-end'>
                                                {% if pieceCNI and pieceCNI.chemin %}
                                                    <a href='{{ asset('uploads/candidatures/' ~ form.vars.value.numCandidature ~ '/' ~ (pieceCNI.chemin|split('/')|last)) }}'
                                                       class='btn btn-xs btn-inverse-primary'
                                                       target='_blank'
                                                       aria-label="Télécharger la CNI">
                                                        <i class='fa fa-download' aria-hidden="true"></i> Télécharger
                                                    </a>
                                                {% else %}
                                                    <span class='badge border-secondary text-secondary' role="status">
                                                <i class='fa fa-exclamation-triangle' aria-hidden="true"></i> Non chargé
                                            </span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class='wrap text-wrap'>Extrait d'acte de naissance/jugement supplétif</td>
                                            <td class='text-end'>
                                                {% if extraitNaissance and extraitNaissance.chemin %}
                                                    <a href='{{ asset('uploads/candidatures/' ~ form.vars.value.numCandidature ~ '/' ~ (extraitNaissance.chemin|split('/')|last)) }}'
                                                       class='btn btn-xs btn-inverse-primary'
                                                       target='_blank'
                                                       aria-label="Télécharger l'extrait de naissance">
                                                        <i class='fa fa-download' aria-hidden="true"></i> Télécharger
                                                    </a>
                                                {% else %}
                                                    <span class='badge border-secondary text-secondary' role="status">
                                                <i class='fa fa-exclamation-triangle' aria-hidden="true"></i> Non chargé
                                            </span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class='wrap text-wrap'>Niveau d'étude/diplôme requis</td>
                                            <td class='text-end'>
                                                {% if diplome and diplome.chemin %}
                                                    <a href='{{ asset('uploads/candidatures/' ~ form.vars.value.numCandidature ~ '/' ~ (diplome.chemin|split('/')|last)) }}'
                                                       class='btn btn-xs btn-inverse-primary'
                                                       target='_blank'
                                                       aria-label="Télécharger le diplôme">
                                                        <i class='fa fa-download' aria-hidden="true"></i> Télécharger
                                                    </a>
                                                {% else %}
                                                    <span class='badge border-secondary text-secondary' role="status">
                                                <i class='fa fa-exclamation-triangle' aria-hidden="true"></i> Non chargé
                                            </span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Fiche d'inscription</td>
                                            <td class='text-end'>
                                                {% if form.vars.value.id %}
                                                    <button type='button' class='btn btn-xs btn-inverse-success' disabled aria-disabled="true">
                                                        <i class='fa fa-print' aria-hidden="true"></i> Imprimer (Non disponible)
                                                    </button>
                                                {% else %}
                                                    <span class='badge border-secondary text-secondary' role="status">
                                                <i class='fa fa-exclamation-triangle' aria-hidden="true"></i> Non disponible
                                            </span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class='alert alert-warning mb-4'>
                    <h5 class='alert-heading'><i class='fa fa-info-circle'></i> Informations importantes</h5>
                    <hr>
                    <div class='row'>
                        <div class='col-md-6'>
                            <p class='mb-1'><strong>Conditions d'âge :</strong></p>
                            <ul class='mb-0'>
                                {% if recrutement.ageMin is defined and recrutement.ageMin is not null %}
                                    <li>Âge minimum requis : {{ recrutement.ageMin }} ans</li>
                                {% endif %}
                                {% if recrutement.ageMax is defined and recrutement.ageMax is not null %}
                                    <li>Âge maximum autorisé : {{ recrutement.ageMax }} ans</li>
                                {% endif %}
                                {% if recrutement.nationalite is defined and recrutement.nationalite is not empty %}
                                    <li>Nationalité : {{ recrutement.nationalite }}</li>
                                {% endif %}
                            </ul>
                        </div>
                        <div class='col-md-6'>
                            <p class='mb-1'><strong>Documents requis :</strong></p>
                            <ul class='mb-0'>
                                <li>Pièce d'identité (CNI ou Passeport)</li>
                                <li>Extrait d'acte de naissance</li>
                                <li><strong>Diplômes (obligatoires)</strong></li>
                                <li>Autres documents justificatifs</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class='card border mb-3'>
                    <div class='card-body text-center'>
                        <h4><i class='fa fa-file-text-o' aria-hidden="true"></i> {{ title|default('Nouvelle Candidature') }}</h4>
                        <p class='text-muted'>Veuillez remplir tous les champs obligatoires pour soumettre votre candidature</p>
                    </div>
                </div>
            {% endif %}

            {{ form_start(form, {'attr': {'id': 'candidature-form'}}) }}

            {% if hidePersonalInfo %}
                <div class='alert alert-info mb-3' role="status">
                    <strong>Informations personnelles reprises automatiquement.</strong>
                    Nous réutilisons les informations déjà enregistrées lors de votre première candidature. Si vous devez les modifier, veuillez mettre à jour votre première candidature avant d'en créer une nouvelle.
                </div>
            {% endif %}

            <div class='card border-secondary mb-3' {% if hidePersonalInfo %}style='display:none;' aria-hidden="true"{% endif %}>
                <div class='card-body'>
                    <h2 class='card-title h5'>INFORMATIONS PERSONNELLES</h2>
                    <div class='row'>
                        <div class='col-md-4 mb-3'>{{ form_row(form.nom) }}</div>
                        <div class='col-md-4 mb-3'>{{ form_row(form.prenom) }}</div>
                        <div class='col-md-4 mb-3'>{{ form_row(form.sexe) }}</div>
                        <div class='col-md-4 mb-3' id='nomJeuneFilleContainer' style='display: none;'>{{ form_row(form.nomJeuneFille) }}</div>
                    </div>
                    <div class='row'>
                        <div class='col-md-4 mb-3'>{{ form_row(form.dateNaissance) }}</div>
                        <div class='col-md-4 mb-3'>{{ form_row(form.lieuNaissance) }}</div>
                        <div class='col-md-4 mb-3'>{{ form_row(form.situationMatrimoniale) }}</div>
                    </div>
                    <div class='row'>
                        <div class='col-md-4 mb-3'>{{ form_row(form.adresse) }}</div>
                 <div class="col-md-4 mb-3">
                    {{ form_label(form.contacts) }}
                    <div class="input-group">
                        <span class="input-group-text bg-white text-muted border-end-0" style="border-right: 0;">+225</span>
                        {{ form_widget(form.contacts, {
                            attr: {
                                class: 'form-control border-start-0 ps-1',
                                style: 'border-left: 0;'
                            }
                        }) }}
                    </div>
                    {{ form_errors(form.contacts) }}
                </div>

                <div class="col-md-4 mb-3">
                    {{ form_label(form.contact2) }}
                    <div class="input-group">
                        <span class="input-group-text bg-white text-muted border-end-0" style="border-right: 0;">+225</span>
                        {{ form_widget(form.contact2, {
                            attr: {
                                class: 'form-control border-start-0 ps-1',
                                style: 'border-left: 0;'
                            }
                        }) }}
                    </div>
                    {{ form_errors(form.contact2) }}
                </div>

                <div class="col-md-6 mb-3">{{ form_row(form.nomPrenomUrgence) }}</div>
                
                <div class="col-md-6 mb-3">
                    {{ form_label(form.contactUrgence, 'Contact urgence') }}
                    <div class="input-group">
                        <span class="input-group-text bg-white text-muted border-end-0" style="border-right: 0;">+225</span>
                        {{ form_widget(form.contactUrgence, { 
                            attr: {
                                class: 'form-control border-start-0 ps-1',
                                style: 'border-left: 0;'
                            }
                        }) }}
                    </div>
                    {{ form_errors(form.contactUrgence) }}
                </div>

                        <div class='col-md-6 mb-3'>{{ form_row(form.nationalite) }}</div>
                        <div class='col-md-6 mb-3'>
                            {{ form_row(form.disponibilite) }}
                        </div>
                        <div class='col-md-6 mb-3'>{{ form_row(form.numCmu) }}</div>
                        <div class='col-md-6 mb-3'>{{ form_row(form.numPiece) }}</div>
                    </div>

                    
                </div>
            </div>

            <div class='card border-secondary mb-3'>
                <div class='card-body'>
                    <h2 class='card-title h5'><i class='fa fa-graduation-cap me-2'></i>NIVEAU D'ÉTUDE</h2>
                    <div class='row'>
                        <div class='col-md-6 mb-3'>{{ form_row(form.niveauEtude) }}</div>
                        <div class='col-md-6 mb-3'>{{ form_row(form.diplome) }}</div>
                        <div style='display: none;'>{{ form_row(form.metier) }}</div>
                    </div>
                </div>
            </div>

            <div class='card border-primary mb-3' id='cfa-selection-section'>
                <div class='card-body'>
                    <h2 class='card-title h5 text-primary'>
                        <i class='fa fa-building me-2'></i>CHOIX DE L'ÉTABLISSEMENT DE FORMATION
                    </h2>
                    <div class='alert alert-info mb-3'>
                        <i class='fa fa-info-circle me-2'></i>
                        <strong>Important :</strong> Sélectionnez d'abord un secteur d'activité, puis un métier pour voir les établissements disponibles.
                    </div>
                    
                    <div class='row'>
                        <div class='col-md-12 mb-4'>
                            <div class='progress-steps d-flex justify-content-between mb-4'>
                                <div class='step-item text-center' id='step-secteur'>
                                    <div class='step-circle bg-secondary text-white rounded-circle d-inline-flex align-items-center justify-content-center' style='width: 50px; height: 50px;'>
                                        <i class='fa fa-industry'></i>
                                    </div>
                                    <div class='step-label mt-2 small'>1. Secteur</div>
                                </div>
                                <div class='step-connector flex-grow-1 align-self-center' style='height: 2px; background: #ddd; margin: 0 10px;'></div>
                                <div class='step-item text-center' id='step-metier'>
                                    <div class='step-circle bg-secondary text-white rounded-circle d-inline-flex align-items-center justify-content-center' style='width: 50px; height: 50px;'>
                                        <i class='fa fa-briefcase'></i>
                                    </div>
                                    <div class='step-label mt-2 small'>2. Métier</div>
                                </div>
                                <div class='step-connector flex-grow-1 align-self-center' style='height: 2px; background: #ddd; margin: 0 10px;'></div>
                                <div class='step-item text-center' id='step-cfa'>
                                    <div class='step-circle bg-secondary text-white rounded-circle d-inline-flex align-items-center justify-content-center' style='width: 50px; height: 50px;'>
                                        <i class='fa fa-school'></i>
                                    </div>
                                    <div class='step-label mt-2 small'>3. Établissement</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class='row'>
                        <div class='col-md-4 mb-3'>
                            <div class='form-group-with-icon'>
                                <i class='fa fa-industry text-muted position-absolute' style='left: 10px; top: 38px; z-index: 10;'></i>
                                {{ form_row(form.secteur, {'attr': {'style': 'padding-left: 35px;'}}) }}
                            </div>
                        </div>
                        <div class='col-md-4 mb-3' id='metier-container'>
                            <div class='form-group-with-icon position-relative'>
                                <i class='fa fa-briefcase text-muted position-absolute' style='left: 10px; top: 38px; z-index: 10;'></i>
                                <label for='candidature_metier_dynamic' class='form-label'>Métier lié au secteur</label>
                                <select id='candidature_metier_dynamic' class='form-control' style='padding-left: 35px;' disabled>
                                    <option value=''>Sélectionnez d'abord un secteur</option>
                                </select>
                                <small class='text-muted'>Ce champ se remplira après avoir choisi un secteur</small>
                            </div>
                        </div>
                        <div class='col-md-4 mb-3'>
                            <div class='form-group-with-icon position-relative'>
                                <i class='fa fa-school text-muted position-absolute' style='left: 10px; top: 38px; z-index: 10;'></i>
                                {{ form_row(form.cfaEtablissement, {'attr': {'style': 'padding-left: 35px;', 'disabled': 'disabled'}}) }}
                                <small class='text-muted' id='cfa-help-text'>Sélectionnez un secteur et un métier pour voir les établissements</small>
                            </div>
                        </div>
                    </div>

                    <div id='cfa-info-display' class='mt-3' style='display: none;'>
                        <div class='alert alert-success'>
                            <h6 class='alert-heading'><i class='fa fa-check-circle me-2'></i>Établissement sélectionné</h6>
                            <div id='cfa-details'></div>
                        </div>
                    </div>
                </div>
            </div>

            {% if type|default(null) != 'recrutement' %}
                <div class='card border-secondary mb-3'>
                    <div class='card-body'>
                        <h2 class='card-title h5'>SITUATION PROFESSIONNELLE</h2>
                        <div class='row'>
                            <div class='col-md-6 mb-3'>{{ form_row(form.situationpro) }}</div>
                            <div class='col-md-6 mb-3'>{{ form_row(form.experience) }}</div>
                            <div class='col-md-6 mb-3'>{{ form_row(form.titrepro) }}</div>
                            <div class='col-md-6 mb-3'>{{ form_row(form.entreprise) }}</div>
                            <div class='col-md-6 mb-3'>{{ form_row(form.direction) }}</div>
                            <div class='col-md-6 mb-3'>{{ form_row(form.fonction) }}</div>
                            <div class='col-md-6 mb-3'>{{ form_row(form.contrat) }}</div>
                            <div class='col-md-6 mb-3'>{{ form_row(form.lieuentreprise) }}</div>
                            <div class='col-md-6 mb-3'>{{ form_row(form.refentreprise) }}</div>
                            <div class='col-md-6 mb-3'>{{ form_row(form.apprentiforme) }}</div>
                            <div class='col-md-6 mb-3'>{{ form_row(form.apprentirecrute) }}</div>
                        </div>
                    </div>
                </div>
            {% endif %}

            <div class='card border mb-3'>
                <div class='card-body'>
                    <h2 class='card-title h5'><i class='fa fa-upload me-2'></i>IMPORTER LES DOCUMENTS</h2>
                    <div class='alert alert-warning mb-3'>
                        <i class='fa fa-exclamation-triangle me-2'></i>
                        <strong>Documents requis :</strong> Assurez-vous que vos fichiers sont clairs et lisibles (PDF, JPG ou PNG).
                    </div>
                    <div class='row'>
                        <div class='col-md-6 mb-3'>
                            <div class='file-upload-wrapper'>
                                <i class='fa fa-id-card text-primary me-2'></i>
                                {{ form_row(form.medias_piece, {
                                    'label': 'CNI ou Attestation d\'Identité',
                                    'attr': {
                                        'class': 'form-control',
                                        'accept': 'application/pdf,image/jpeg,image/png',
                                        'data-type': 'CNI'
                                    }
                                }) }}
                                <small class='text-muted'><i class='fa fa-info-circle'></i> CNI ou Attestation d'Identité (PDF, JPG, PNG - Max 2MB)</small>
                            </div>
                        </div>
                        <div class='col-md-6 mb-3'>
                            <div class='file-upload-wrapper'>
                                <i class='fa fa-file-text text-info me-2'></i>
                                {{ form_row(form.medias_extrait, {
                                    'label': 'Extrait de naissance',
                                    'attr': {
                                        'class': 'form-control',
                                        'accept': 'application/pdf,image/jpeg,image/png',
                                        'data-type': 'EXTRACT_NAISSANCE'
                                    }
                                }) }}
                                <small class='text-muted'><i class='fa fa-info-circle'></i> Extrait d'acte de naissance (PDF, JPG, PNG - Max 2MB)</small>
                            </div>
                        </div>
                        <div class='col-md-6 mb-3'>
                            <div class='file-upload-wrapper'>
                                <i class='fa fa-certificate text-warning me-2'></i>
                                {{ form_row(form.medias_niveau, {
                                    'attr': {
                                        'class': 'form-control',
                                        'accept': 'application/pdf,image/jpeg,image/png',
                                        'data-type': 'DIPLOME'
                                    }
                                }) }}
                                <small class='text-muted'><i class='fa fa-info-circle'></i> Diplôme ou attestation de niveau (PDF, JPG, PNG - Max 2MB)</small>
                            </div>
                        </div>
                        <div class='col-md-6 mb-3'>
                            <div class='file-upload-wrapper'>
                                <i class='fa fa-medkit text-success me-2'></i>
                                {{ form_row(form.medias_cmu, {
                                    'label': 'Carte CMU',
                                    'attr': {
                                        'class': 'form-control',
                                        'accept': 'application/pdf,image/jpeg,image/png',
                                        'data-type': 'CMU'
                                    }
                                }) }}
                                <small class='text-muted'><i class='fa fa-info-circle'></i> Carte CMU (PDF, JPG, PNG - Max 2MB)</small>
                            </div>
                        </div>
                        <div class='col-md-6 mb-3'>
                            <div class='file-upload-wrapper'>
                                <i class='fa fa-camera text-danger me-2'></i>
                                {{ form_row(form.medias_photo, {
                                    'label': 'Photo d\'identité',
                                    'attr': {
                                        'class': 'form-control',
                                        'accept': 'image/jpeg,image/png',
                                        'data-type': 'PHOTO'
                                    }
                                }) }}
                                <small class='text-muted'><i class='fa fa-info-circle'></i> Photo d'identité récente (JPG, PNG - Max 1MB)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style='display: none;'>
                {% if form.dateCandidature is defined %}
                    {{ form_widget(form.dateCandidature) }}
                {% endif %}
                {% if form.numCandidature is defined %}
                    {{ form_widget(form.numCandidature) }}
                {% endif %}
            </div>

            <div class="form-buttons-container">
            <button type='submit' class='btn btn-primary'>
                    <i class="fa fa-send me-2" aria-hidden="true"></i>
                    {{ button_label|default('Soumettre ma candidature') }}
                </button>
               
                <button type='reset' class='btn btn-outline-secondary'>
                    <i class="fa fa-times me-2" aria-hidden="true"></i>
                    Annuler
                </button>
                 <a href='{{ path('app_candidature_index') }}' class='btn btn-secondary'>
                    <i class="fa fa-arrow-left me-2" aria-hidden="true"></i>
                    Retour à la liste
                </a>
                
            </div>

            {{ form_end(form) }}
        </div>
    {% endblock %}

    {% block javascripts %}
        {{ parent() }}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const sexeSelect = document.getElementById('{{ form.sexe.vars.id }}');
                const nomJeuneFilleContainer = document.getElementById('nomJeuneFilleContainer');
                const nomJeuneFilleInput = document.getElementById('{{ form.nomJeuneFille.vars.id }}');

                function toggleNomJeuneFille() {
                    if (sexeSelect && sexeSelect.value === 'FEMININ') {
                        nomJeuneFilleContainer.style.display = 'block';
                        if (nomJeuneFilleInput) {
                            nomJeuneFilleInput.required = true;
                        }
                    } else {
                        nomJeuneFilleContainer.style.display = 'none';
                        if (nomJeuneFilleInput) {
                            nomJeuneFilleInput.required = false;
                            nomJeuneFilleInput.value = '';
                        }
                    }
                }

                if (sexeSelect) {
                    sexeSelect.addEventListener('change', toggleNomJeuneFille);
                    toggleNomJeuneFille();
                }

                // Logique dynamique Secteur → Métier → CFA
                const secteurSelect = document.getElementById('candidature_secteur');
                const metierDynamicSelect = document.getElementById('candidature_metier_dynamic');
                const cfaSelect = document.getElementById('candidature_cfaEtablissement');
                const cfaInfoDisplay = document.getElementById('cfa-info-display');
                const cfaDetails = document.getElementById('cfa-details');
                const cfaHelpText = document.getElementById('cfa-help-text');

                // Éléments de progression visuelle
                const stepSecteur = document.getElementById('step-secteur');
                const stepMetier = document.getElementById('step-metier');
                const stepCfa = document.getElementById('step-cfa');

                function updateStepStatus(step, status) {
                    const circle = step.querySelector('.step-circle');
                    circle.classList.remove('bg-secondary', 'bg-primary', 'bg-success');
                    
                    if (status === 'active') {
                        circle.classList.add('bg-primary');
                    } else if (status === 'completed') {
                        circle.classList.add('bg-success');
                    } else {
                        circle.classList.add('bg-secondary');
                    }
                }

                // Gestion du changement de secteur
                if (secteurSelect) {
                    secteurSelect.addEventListener('change', function() {
                        const secteurId = this.value;
                        
                        // Réinitialiser les champs suivants
                        metierDynamicSelect.innerHTML = '<option value="">Chargement...</option>';
                        metierDynamicSelect.disabled = true;
                        cfaSelect.innerHTML = '<option value="">Sélectionnez d\'abord un métier</option>';
                        cfaSelect.disabled = true;
                        cfaInfoDisplay.style.display = 'none';
                        
                        if (secteurId) {
                            updateStepStatus(stepSecteur, 'completed');
                            updateStepStatus(stepMetier, 'active');
                            updateStepStatus(stepCfa, 'pending');
                            
                            // Charger les métiers du secteur
                            fetch(`{{ path('app_candidature_metiers_by_secteur', {'secteurId': '__SECTEUR_ID__'}) }}`.replace('__SECTEUR_ID__', secteurId))
                                .then(response => response.json())
                                .then(metiers => {
                                    metierDynamicSelect.innerHTML = '<option value="">Sélectionnez un métier</option>';
                                    
                                    if (metiers.length === 0) {
                                        metierDynamicSelect.innerHTML = '<option value="">Aucun métier disponible</option>';
                                    } else {
                                        metiers.forEach(metier => {
                                            const option = document.createElement('option');
                                            option.value = metier.id;
                                            option.textContent = metier.nom;
                                            if (metier.description) {
                                                option.title = metier.description;
                                            }
                                            metierDynamicSelect.appendChild(option);
                                        });
                                        metierDynamicSelect.disabled = false;
                                    }
                                })
                                .catch(error => {
                                    console.error('Erreur lors du chargement des métiers:', error);
                                    metierDynamicSelect.innerHTML = '<option value="">Erreur de chargement</option>';
                                });
                        } else {
                            updateStepStatus(stepSecteur, 'active');
                            updateStepStatus(stepMetier, 'pending');
                            updateStepStatus(stepCfa, 'pending');
                            metierDynamicSelect.innerHTML = '<option value="">Sélectionnez d\'abord un secteur</option>';
                        }
                    });
                }

                // Récupérer le champ metier caché pour le synchroniser
                const metierHiddenSelect = document.getElementById('{{ form.metier.vars.id }}');

                // Gestion du changement de métier
                if (metierDynamicSelect) {
                    metierDynamicSelect.addEventListener('change', function() {
                        const metierId = this.value;
                        
                        // Synchroniser avec le champ caché
                        if (metierHiddenSelect) {
                            metierHiddenSelect.value = metierId;
                        }
                        
                        cfaSelect.innerHTML = '<option value="">Chargement...</option>';
                        cfaSelect.disabled = true;
                        cfaInfoDisplay.style.display = 'none';
                        
                        if (metierId) {
                            updateStepStatus(stepMetier, 'completed');
                            updateStepStatus(stepCfa, 'active');
                            
                            // Charger les CFA pour ce métier
                            fetch(`{{ path('app_candidature_cfa_by_metier', {'metierId': '__METIER_ID__'}) }}`.replace('__METIER_ID__', metierId))
                                .then(response => response.json())
                                .then(cfaList => {
                                    cfaSelect.innerHTML = '<option value="">Sélectionnez un établissement</option>';
                                    
                                    if (cfaList.length === 0) {
                                        cfaSelect.innerHTML = '<option value="">Aucun établissement disponible pour ce métier</option>';
                                        cfaHelpText.innerHTML = '<i class="fa fa-exclamation-triangle text-warning"></i> Aucun établissement trouvé pour ce métier';
                                    } else {
                                        cfaList.forEach(cfa => {
                                            const option = document.createElement('option');
                                            option.value = cfa.id;
                                            option.textContent = `${cfa.nom} - ${cfa.region}`;
                                            option.dataset.region = cfa.region;
                                            option.dataset.email = cfa.email;
                                            cfaSelect.appendChild(option);
                                        });
                                        cfaSelect.disabled = false;
                                        cfaHelpText.innerHTML = `<i class="fa fa-check-circle text-success"></i> ${cfaList.length} établissement(s) disponible(s)`;
                                    }
                                })
                                .catch(error => {
                                    console.error('Erreur lors du chargement des CFA:', error);
                                    cfaSelect.innerHTML = '<option value="">Erreur de chargement</option>';
                                    cfaHelpText.innerHTML = '<i class="fa fa-times-circle text-danger"></i> Erreur lors du chargement';
                                });
                        } else {
                            updateStepStatus(stepMetier, 'active');
                            updateStepStatus(stepCfa, 'pending');
                            cfaSelect.innerHTML = '<option value="">Sélectionnez d\'abord un métier</option>';
                            cfaHelpText.innerHTML = 'Sélectionnez un secteur et un métier pour voir les établissements';
                        }
                    });
                }

                // Gestion de la sélection du CFA
                if (cfaSelect) {
                    cfaSelect.addEventListener('change', function() {
                        const selectedOption = this.options[this.selectedIndex];
                        
                        if (this.value && selectedOption.dataset.region) {
                            updateStepStatus(stepCfa, 'completed');
                            
                            cfaDetails.innerHTML = `
                                <p class="mb-1"><strong><i class="fa fa-building me-2"></i>Nom :</strong> ${selectedOption.textContent}</p>
                                <p class="mb-1"><strong><i class="fa fa-map-marker me-2"></i>Région :</strong> ${selectedOption.dataset.region}</p>
                                <p class="mb-0"><strong><i class="fa fa-envelope me-2"></i>Email :</strong> ${selectedOption.dataset.email || 'Non renseigné'}</p>
                            `;
                            cfaInfoDisplay.style.display = 'block';
                        } else {
                            updateStepStatus(stepCfa, 'active');
                            cfaInfoDisplay.style.display = 'none';
                        }
                    });
                }

                // Animation des fichiers uploadés
                const fileInputs = document.querySelectorAll('input[type="file"]');
                fileInputs.forEach(input => {
                    input.addEventListener('change', function() {
                        const wrapper = this.closest('.file-upload-wrapper');
                        if (this.files.length > 0) {
                            wrapper.style.backgroundColor = '#d4edda';
                            wrapper.style.transition = 'background-color 0.3s';
                            setTimeout(() => {
                                wrapper.style.backgroundColor = '';
                            }, 2000);
                        }
                    });
                });
            });
        </script>
    {% endblock %}

    
    

{% endblock %}
