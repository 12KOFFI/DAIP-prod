{% extends 'base.html.twig' %}

{% block title %}{{ prospection_metier.id ? 'Modifier le Poste Prospecte' : '  Nouveau Postes  Prospectes' }}{% endblock %}

{% set flow_prospection_id = app.request.query.get('prospectionId') %}

{# template.html.twig #}
{% block page_content %}
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                        <h1 class="h4 mb-0">
                            {{ prospection_metier.id ? 'Modifier le Poste Prospecte' : 'Créer un Nouveau Poste Prospecte' }}
                        </h1>
                        <a href="{{ path('app_prospection_metier_index') }}" class="btn btn-outline-secondary btn-sm">
                            Retour
                        </a>
                    </div>
                    <div class="card-body">
                        {% for message in app.flashes('error') %}
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                        {{ form_start(form, { attr: { id: 'prospection-metier-form' } }) }}
                            {{ form_widget(form) }}
                            <div class="mt-3 d-flex justify-content-between">
                                <a href="{{ path('app_prospection_metier_index') }}" class="btn btn-outline-secondary">
                                    Retour
                                </a>
                                <div class="d-flex gap-2">
                                    <button type="submit" id="save-btn" class="btn btn-primary">
                                        {{ prospection_metier.id ? 'Mettre à jour' : 'Enregistrer' }}
                                    </button>
                                </div>
                            </div>
                        {{ form_end(form) }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('prospection-metier-form');
            const prospectionSelect = document.getElementById('{{ form.prospection.vars.id }}');
            const metierSelect = document.getElementById('{{ form.metier.vars.id }}');
            const nombrePostesInput = document.getElementById('{{ form.nombre_postes.vars.id }}');
            const urlParams = new URLSearchParams(window.location.search);
            const queryProspectionId = urlParams.get('prospectionId');
            const isEditMode = {{ prospection_metier.id ? 'true' : 'false' }};

            if (!prospectionSelect || !metierSelect) {
                return;
            }

            if (queryProspectionId) {
                prospectionSelect.value = queryProspectionId;
                prospectionSelect.dispatchEvent(new Event('change'));
                const prospectionRow = prospectionSelect.closest('.mb-3');
                if (prospectionRow) {
                    prospectionRow.classList.add('d-none');
                }
            }

            const baseUrl = '{{ path('app_prospection_metier_metiers', {'id': 0}) }}';

            const updateMetiers = function () {
                const prospectionId = prospectionSelect.value;

                while (metierSelect.firstChild) {
                    metierSelect.removeChild(metierSelect.firstChild);
                }

                const placeholderOption = document.createElement('option');
                placeholderOption.value = '';
                placeholderOption.textContent = 'Sélectionnez un métier';
                metierSelect.appendChild(placeholderOption);

                if (!prospectionId) {
                    return;
                }

                const url = baseUrl.replace('/0', '/' + prospectionId);

                fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Erreur HTTP ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        data.forEach(function (item) {
                            const option = document.createElement('option');
                            option.value = item.id;
                            option.textContent = item.nom;
                            metierSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Erreur lors du chargement des métiers :', error);
                    });
            };

            prospectionSelect.addEventListener('change', updateMetiers);

            if (form) {
                form.addEventListener('submit', async function (event) {
                    // Si c'est une édition, laisser le formulaire se soumettre normalement
                    if (isEditMode) {
                        return; // Soumission normale du formulaire Symfony
                    }

                    // Sinon, utiliser l'API pour la création
                    event.preventDefault();

                    const prospectionId = queryProspectionId || prospectionSelect.value;
                    const metierId = metierSelect.value;
                    const nombrePostes = nombrePostesInput ? nombrePostesInput.value : '';

                    if (!prospectionId) {
                        alert('Prospection manquante. Veuillez recommencer le processus.');
                        return;
                    }

                    if (!metierId) {
                        alert('Veuillez sélectionner un métier.');
                        return;
                    }

                    if (!nombrePostes || Number(nombrePostes) < 1) {
                        alert('Veuillez saisir un nombre de postes valide.');
                        return;
                    }

                    try {
                        const response = await fetch('{{ path('app_api_prospection_metier_create') }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({
                                prospectionId: Number(prospectionId),
                                metierId: Number(metierId),
                                nombrePostes: Number(nombrePostes)
                            })
                        });

                        const data = await response.json();
                        if (!response.ok) {
                            alert(data.message || 'Erreur lors de la création de la prospection métier.');
                            return;
                        }

                        // Rediriger vers la liste
                        window.location.href = '{{ path('app_prospection_metier_index') }}';
                    } catch (error) {
                        console.error(error);
                        alert('Erreur réseau lors de la création de la prospection métier.');
                    }
                });
            }
        });
    </script>
{% endblock %}