{% extends 'base.html.twig' %}

{% block page_content %}
    <div class="recrutement-form-wrapper">
        <div class="row mt-4 justify-content-center">
            <div class="col-lg-10 col-xl-9">

                {# En-tête #}
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-4">
                    <div>
                        <h4 class="mb-1 fw-bold">{{ title|default('Nouveau recrutement') }}</h4>
                        <p class="text-muted mb-0 small">Remplissez les sections pour créer ou modifier une campagne de recrutement.</p>
                    </div>
                    <a href="{{ path('app_recrutement_index') }}" class="btn btn-outline-secondary btn-sm text-nowrap">
                        <i class="link-icon" data-feather="arrow-left"></i> Retour à la liste
                    </a>
                </div>

                

                {{ form_start(form, {'attr': {'class': 'forms-sample recrutement-form'}}) }}

            {# ═══════════════════════════════════════════════════════════════ #}
            {# SECTION 1 — Informations générales                            #}
            <div class="card mb-4 border-0 shadow-sm recrutement-form-card">
                <div class="card-header bg-primary bg-opacity-10 border-0 py-3">
                    <h5 class="card-title mb-0 text-primary d-flex align-items-center">
                        <span class="step-num rounded-circle bg-primary text-white me-2 d-inline-flex align-items-center justify-content-center" style="width: 28px; height: 28px; font-size: 0.85rem;">1</span>
                        <i class="link-icon me-2" data-feather="clipboard"></i>
                        Informations générales
                    </h5>
                </div>
                <div class="card-body py-4">
                    <p class="text-muted small mb-3">Définissez le nom, les dates et le statut de votre campagne de recrutement.</p>

                    <div class="row">
                        <div class="col-12 mb-3">
                            {{ form_row(form.libelle) }}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            {{ form_row(form.dateDebut) }}
                        </div>
                        <div class="col-md-4">
                            {{ form_row(form.dateFin) }}
                        </div>
                        <div class="col-md-4">
                            {{ form_row(form.status) }}
                        </div>
                    </div>
                </div>
            </div>

            {# ═══════════════════════════════════════════════════════════════ #}
            {# SECTION 2 — Critères du recrutement                           #}
            <div class="card mb-4 border-0 shadow-sm recrutement-form-card">
                <div class="card-header bg-primary bg-opacity-10 border-0 py-3">
                    <h5 class="card-title mb-0 text-primary d-flex align-items-center">
                        <span class="step-num rounded-circle bg-primary text-white me-2 d-inline-flex align-items-center justify-content-center" style="width: 28px; height: 28px; font-size: 0.85rem;">2</span>
                        <i class="link-icon me-2" data-feather="filter"></i>
                        Critères du recrutement
                    </h5>
                </div>
                <div class="card-body py-4">
                    <p class="text-muted small mb-3">Précisez le profil recherché : tranche d'âge, public cible, métiers concernés.</p>

                    

                    {# Le champ 'cible' (Public cible) a été retiré #}

                    <div class="row">
                        <div class="col-md-3">{{ form_row(form.ageMin) }}</div>
                        <div class="col-md-3">{{ form_row(form.ageMax) }}</div>
                        <div class="col-md-3">{{ form_row(form.dateLimiteAge) }}</div>
                        <div class="col-md-3">{{ form_row(form.nationalite) }}</div>
                    </div>

                    {# Métiers #}
                    <div class="p-3 bg-light rounded mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="link-icon" data-feather="briefcase"></i> Métiers concernés</h6>
                            <a href="{{ path('app_metier_new') }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="link-icon" data-feather="plus"></i> Nouveau métier
                            </a>
                        </div>
                        <small class="text-muted d-block mb-2">Sélectionnez un ou plusieurs métiers. Maintenez <kbd>Ctrl</kbd> pour en sélectionner plusieurs.</small>
                        <div class="input-group mb-2">
                            <span class="input-group-text"><i class="link-icon" data-feather="search"></i></span>
                            <input type="text" class="form-control" id="{{ form.metiers.vars.id }}_search" placeholder="Tapez pour filtrer les métiers...">
                            <button type="button" class="btn btn-outline-secondary" id="{{ form.metiers.vars.id }}_filter_btn">Filtrer</button>
                        </div>
                        {{ form_widget(form.metiers, {'attr': {'class': 'form-select', 'size': '6'}}) }}
                        {{ form_errors(form.metiers) }}
                    </div>

                    

                    {# Projet et Centre #}
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0"><i class="link-icon" data-feather="folder"></i> Projet</h6>
                                </div>
                                {{ form_widget(form.projet, {'attr': {'class': 'form-select'}}) }}
                                {{ form_errors(form.projet) }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0"><i class="link-icon" data-feather="map-pin"></i> Centre</h6>
                                    <a href="{{ path('app_centre_new') }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="link-icon" data-feather="plus"></i> Nouveau
                                    </a>
                                </div>
                                {{ form_widget(form.centre, {'attr': {'class': 'form-select'}}) }}
                                {{ form_errors(form.centre) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            


            <div class="card mb-4 border-0 shadow-sm recrutement-form-card">
                <div class="card-header bg-primary bg-opacity-10 border-0 py-3 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0 text-primary d-flex align-items-center">
                        <span class="step-num rounded-circle bg-primary text-white me-2 d-inline-flex align-items-center justify-content-center" style="width: 28px; height: 28px; font-size: 0.85rem;">3</span>
                        <i class="link-icon me-2" data-feather="file-text"></i>
                        Contenu de l'annonce
                    </h5>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#section-annonce" aria-expanded="true">
                        <i class="link-icon" data-feather="chevron-down"></i> Afficher / Masquer
                    </button>
                </div>
                <div class="collapse show" id="section-annonce">
                    <div class="card-body">
                        <p class="text-muted small mb-3">Ces informations seront visibles par les candidats sur la page de l'annonce.</p>

                        {# Texte de l'annonce #}
                        <div class="mb-3">
                            {{ form_row(form.texte_annonce) }}
                            <small class="text-muted">Ce texte apparaîtra sur la bannière de l'annonce</small>
                        </div>

                        {# Image de l'annonce #}
                        <div class="mb-3">
                            {{ form_row(form.imageAnnonce) }}
                            {% if recrutement.imageAnnonce %}
                                <div class="mt-2 p-2 bg-light rounded d-inline-block">
                                    <img src="{{ asset('uploads/recrutement/image_annonce/' ~ recrutement.imageAnnonce|split('/')|last) }}" alt="Image actuelle" class="img-thumbnail" style="max-width: 200px;">
                                    <p class="text-muted small mt-1 mb-0">Image actuelle — téléchargez un nouveau fichier pour la remplacer</p>
                                </div>
                            {% endif %}
                        </div>

                        {# Période d'inscription #}
                        <div class="mb-3">
                            {{ form_row(form.date_inscription) }}
                        </div>

                        {# Public cible du recrutement #}
                        <div class="p-3 border rounded mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0"><i class="link-icon" data-feather="users"></i> Public cible du recrutement</h6>
                                <button type="button" class="btn btn-sm btn-outline-primary add-parcours">
                                    <i class="link-icon" data-feather="plus"></i> Ajouter
                                </button>
                            </div>
                            <small class="text-muted d-block mb-2">Listez les profils de candidats visés par ce recrutement.</small>
                            <div class="parcours-collection" data-prototype="{{ form_widget(form.listeParcours.vars.prototype)|e('html_attr') }}">
                                {% for parcours in form.listeParcours %}
                                    <div class="parcours-item mb-2 d-flex align-items-center">
                                        {{ form_widget(parcours, {'attr': {'class': 'form-control me-2'}}) }}
                                        <button type="button" class="btn btn-sm btn-outline-danger remove-parcours">
                                            <i class="link-icon" data-feather="x"></i>
                                        </button>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        {# Texte descriptif des parcours #}
                        <div class="mb-3">
                            {{ form_row(form.texteParcours) }}
                        </div>

                        {# Conditions de candidature #}
                        <div class="p-3 border rounded mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0"><i class="link-icon" data-feather="check-square"></i> Conditions de candidature</h6>
                                <button type="button" class="btn btn-sm btn-outline-primary add-condition">
                                    <i class="link-icon" data-feather="plus"></i> Ajouter
                                </button>
                            </div>
                            <small class="text-muted d-block mb-2">Précisez les conditions requises pour pouvoir candidater.</small>
                            <div class="con-candidature-collection" data-prototype="{{ form_widget(form.conCandidature.vars.prototype)|e('html_attr') }}">
                                {% for condition in form.conCandidature %}
                                    <div class="condition-item mb-2 d-flex align-items-center">
                                        {{ form_widget(condition, {'attr': {'class': 'form-control me-2'}}) }}
                                        <button type="button" class="btn btn-sm btn-outline-danger remove-condition">
                                            <i class="link-icon" data-feather="x"></i>
                                        </button>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        {# Dossier de candidature #}
                        <div class="p-3 border rounded mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0"><i class="link-icon" data-feather="folder-plus"></i> Dossier de candidature</h6>
                                <button type="button" class="btn btn-sm btn-outline-primary add-document">
                                    <i class="link-icon" data-feather="plus"></i> Ajouter
                                </button>
                            </div>
                            <small class="text-muted d-block mb-2">Listez les documents que le candidat devra fournir.</small>
                            <div class="dos-candidature-collection" data-prototype="{{ form_widget(form.DosCandidature.vars.prototype)|e('html_attr') }}">
                                {% for document in form.DosCandidature %}
                                    <div class="document-item mb-2 d-flex align-items-center">
                                        {{ form_widget(document, {'attr': {'class': 'form-control me-2'}}) }}
                                        <button type="button" class="btn btn-sm btn-outline-danger remove-document">
                                            <i class="link-icon" data-feather="x"></i>
                                        </button>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# ═══════════════════════════════════════════════════════════════ #}
            {# SECTION 4 — Visuels                                           #}
            <div class="card mb-4 border-0 shadow-sm recrutement-form-card">
                <div class="card-header bg-primary bg-opacity-10 border-0 py-3 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0 text-primary d-flex align-items-center">
                        <span class="step-num rounded-circle bg-primary text-white me-2 d-inline-flex align-items-center justify-content-center" style="width: 28px; height: 28px; font-size: 0.85rem;">4</span>
                        <i class="link-icon me-2" data-feather="image"></i>
                        Visuels
                    </h5>
                    <span class="badge bg-secondary">Optionnel</span>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">Ajoutez des visuels pour personnaliser l'apparence de votre annonce. Formats acceptés : JPEG, PNG.</p>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="p-3 border rounded text-center h-100">
                                <i class="link-icon mb-2" data-feather="image" style="width: 32px; height: 32px;"></i>
                                <p class="small fw-bold mb-1">Image principale</p>
                                <p class="text-muted small mb-2">Affichée dans les offres (Max 5 Mo)</p>
                                {{ form_widget(form.image) }}
                                {{ form_errors(form.image) }}
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="p-3 border rounded text-center h-100">
                                <i class="link-icon mb-2" data-feather="award" style="width: 32px; height: 32px;"></i>
                                <p class="small fw-bold mb-1">Logo</p>
                                <p class="text-muted small mb-2">Max 2 Mo</p>
                                {{ form_widget(form.logo) }}
                                {{ form_errors(form.logo) }}
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="p-3 border rounded text-center h-100">
                                <i class="link-icon mb-2" data-feather="monitor" style="width: 32px; height: 32px;"></i>
                                <p class="small fw-bold mb-1">Bannière</p>
                                <p class="text-muted small mb-2">Max 5 Mo</p>
                                {{ form_widget(form.banniere) }}
                                {{ form_errors(form.banniere) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# ═══════════════════════════════════════════════════════════════ #}
            {# SECTION 5 — Actions                                           #}
            <div class="card mb-4 border-0 bg-light">
                <div class="card-body py-4 d-flex flex-column flex-sm-row justify-content-between align-items-center gap-3">
                    <a href="{{ path('app_recrutement_index') }}" class="btn btn-outline-secondary order-2 order-sm-1">
                        <i class="link-icon" data-feather="x"></i> Annuler
                    </a>
                    <button type="submit" class="btn btn-primary btn-lg px-5 order-1 order-sm-2 {{ app.request.get('_route') ends with '_edit' ? 'edit-mode' : '' }}">
                        <i class="link-icon" data-feather="save"></i>
                        {{ button_label|default(app.request.get('_route') ends with '_edit' ? 'Mettre à jour le recrutement' : 'Enregistrer le recrutement') }}
                    </button>
                </div>
            </div>

            {{ form_end(form) }}

            </div>
        </div>
    </div>

    <style>
        .recrutement-form-wrapper .form-control:focus,
        .recrutement-form-wrapper .form-select:focus {
            border-color: rgba(var(--bs-primary-rgb), 0.5);
            box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.15);
        }
        .recrutement-form-card .card-header {
            font-weight: 600;
        }
        .recrutement-form-wrapper .form-label {
            font-weight: 500;
            color: #374151;
        }
        
        /* Styles pour les boutons en mode édition */
        .edit-mode {
            background-color: #198754;
            border-color: #198754;
        }
        .edit-mode:hover {
            background-color: #157347;
            border-color: #146c43;
        }
        
        /* Correction pour les boutons dans les collections */
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1.5;
            border-radius: 0.2rem;
        }
        
        /* S'assurer que les boutons sont visibles en mode édition */
        .condition-item button, .document-item button, .parcours-item button {
            display: flex !important;
            align-items: center;
            justify-content: center;
            min-width: 32px;
        }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('assets/js/parcours-collection.js') }}"></script>
    <script>
        (function() {
            // ── Filtre métiers ──
            const metiersSelectId = {{ form.metiers.vars.id|json_encode|raw }};

            function initMetiersFilter() {
                const select = document.getElementById(metiersSelectId);
                const input = document.getElementById(metiersSelectId + '_search');
                const btn = document.getElementById(metiersSelectId + '_filter_btn');

                if (!input || !select) return;

                function normalize(s) {
                    return (s || '').toString().trim().toLowerCase();
                }

                const originalOptions = Array.from(select.options).map(function(opt) {
                    return {
                        value: opt.value,
                        text: opt.textContent,
                        disabled: opt.disabled,
                        selected: opt.selected,
                    };
                });

                function rebuildOptions() {
                    const q = normalize(input.value);
                    const selectedValues = new Set(Array.from(select.selectedOptions).map(o => o.value));

                    select.innerHTML = '';

                    originalOptions.forEach(function(item) {
                        if (!item.value) {
                            const opt = document.createElement('option');
                            opt.value = item.value;
                            opt.textContent = item.text;
                            opt.disabled = item.disabled;
                            opt.selected = item.selected;
                            select.appendChild(opt);
                            return;
                        }

                        const matches = q.length === 0 || normalize(item.text).includes(q);
                        if (!matches && !selectedValues.has(item.value)) return;

                        const opt = document.createElement('option');
                        opt.value = item.value;
                        opt.textContent = item.text;
                        opt.disabled = item.disabled;
                        opt.selected = selectedValues.has(item.value);
                        select.appendChild(opt);
                    });
                }

                if (btn) btn.addEventListener('click', rebuildOptions);

                input.addEventListener('input', function() {
                    if (normalize(input.value).length === 0) rebuildOptions();
                });

                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        rebuildOptions();
                    }
                });
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    initMetiersFilter();
                    initSecteursCollection();
                });
            } else {
                initMetiersFilter();
                initSecteursCollection();
            }
        })();
    </script>
{% endblock %}
